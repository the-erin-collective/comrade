<div class="chat-output" #chatContainer>

  
  <div class="messages-container">
    @for (message of messages || []; track trackByMessageId($index, message)) {
      <div class="message" [ngClass]="getMessageClasses(message)" *ngIf="message" [class.streaming]="message.isStreaming && !message.isComplete">
        @if (message.isStreaming && !message.isComplete) {
          <div class="streaming-indicator"></div>
        }
        
        <div class="message-header">
          <span class="sender-icon">{{ getSenderIcon(message) }}</span>
          <span class="sender-name">{{ getSenderName(message) }}</span>
          @if (message.agentId) {
            <span class="agent-id">{{ message.agentId }}</span>
          }
          <span class="timestamp">{{ message.timestamp | timestamp }}</span>
          
          @if (message.isStreaming && !message.isComplete) {
            <div class="typing-indicator">
              <div class="dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span class="streaming-status">AI is thinking</span>
            </div>
          }
        </div>
        
        <div class="message-content">
          @if (message.error) {
            <div class="error-message">
              <span class="error-icon">‚ö†Ô∏è</span>
              <span class="error-text">{{ message.error }}</span>
            </div>
          }
          
          @if (message.content) {
            <div class="message-text streaming-message">
              @for (chunk of splitContentIntoChunks(message.content); track $index) {
                <div class="content-chunk" [innerHTML]="chunk | safeHtml"></div>
              }
            </div>
          }
          
          @if (message.toolCall) {
            <div class="tool-call">
              <h4>Tool Call: {{ message.toolCall.name }}</h4>
              <pre>{{ message.toolCall.arguments | json }}</pre>
            </div>
          }
          
          @if (message.toolResult) {
            <div class="tool-result" [ngClass]="getToolStatusClass(message)">
              <div class="tool-result-header">
                <span class="tool-status">{{ getToolStatus(message) }}</span>
                @if (message.toolResult.metadata?.executionTime) {
                  <span class="execution-time">
                    ({{ message.toolResult.metadata?.executionTime | number:'1.0-2' }}s)
                  </span>
                }
              </div>
              @if (message.toolResult.output) {
                <pre class="tool-output">{{ message.toolResult.output }}</pre>
              }
              @if (message.toolResult.error) {
                <div class="tool-error">{{ message.toolResult.error }}</div>
              }
            </div>
          }
        </div>
      </div>
    }
    
    @if (isLoading) {
      <div class="message loading-message assistant">
        <div class="message-header">
          <span class="sender-icon">ü§ñ</span>
          <span class="sender-name">Assistant</span>
          <span class="timestamp">{{ getCurrentTime() }}</span>
        </div>
        <div class="loading-indicator">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="loading-text">{{ loadingMessage }}</div>
        </div>
      </div>
    }
  </div>
</div>
